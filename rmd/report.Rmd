---
title: "Effect of alcohol regulation and drunk driving laws on alcohol-involved traffic fatalities ratio: 1982-1988 US traffic fatalities for the lower 48 states"  
author: "TEam 2: Zeng Fung Liew (913802324), Yixing Lu (915501254), Liela Meng (917843295), Apurv Srivastav (918936075)"
date: "February 12, 2021"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo=FALSE, warning=FALSE, message=FALSE)
```

# Abstract

# Introduction
Traffic fatalites are a major cause of death in the United States, especially a leading cause of death in the first three decades of life [1]. Alcohol is involved in almost one third of the traffic fatalities nationwide. In 2016, 10,497 people died in alcohol-impaired driving crashes, accounting 28% of traffic fatalities in US [2]. It has been shown that a variety of individual skills would be impaired with a blood alcohol concentration (BAC) level well below 0.05%, and the risk of crashes increased exponentially [3].

From 1980s to 2010s, the deaths resulting from motorvehicle collisions declined by nearly 35% [4]. It coincided with the period of time (1980-1985) when many states made considerable amount of legislative reforms in order to reduce drunken driving and fatal automobile crashes: increasing minimum drinking age to 21, adopting criminal and administrative per se laws, and instituting penalty increases for drunken driving [5]. Many previous studies had shown that the adoption of alcohol regulations and alcohol-impaired driving laws could reduce fatal car crashes: defining BAC limits for drivers at 0.08 or lower [6]; minumum drinking age (21) laws and zero-tolerance laws dor younger drivers [7], fines and jail sentences for alcohol-impaired driving [8].

Although given these evidence for the effectiveness of adopting alcohol regulations and drunken driving punishment laws on reducing alcohol-related traffic fatalities, the traffic policy enviornment in diffrent states often varied a lot, and many socioecnomic factors that can potentially impact alcohol-involved traffic fatalies are not consistent across states. Therefore, the objective of the current project is to investigate _the effect of alcohol regulation and alcohol-impaired driving laws on the proportion of alcohol-involved fatalities among all traffic fatalities, controlling for state-specific unobservable confounders_. 

# Background 
The data for this project comes from a study in the Journal of Health Economics. However, alcohol related traffic incidents are not anything new. In 1996, a study looked into vehicle fatalities from 1982 to 1988. The data was obtained from the National Highway Traffic Safety Administration’s Fatal Accident Reporting System (FARS). They conducted a population-based study that observed traffic fatalities from 48 states (excludes Alaska, Hawaii, and District of Columbia) over 7 years There were 336 observations on 34 different variables, however California had missing values in the year 1988 so that observation was omitted leading to 335 observations. The reason this study is important is that these were the last years that states had differing minimum drinking ages. After 1988, the drinking age increased to 21 years old throughout the United States. The predictor variables that were examined in the study were state, year, spirits consumption, unemployment rate, per capita personal income, employment//population ratio, tax on a case of beer, percent of people who were Southern Baptist, percent of people who were Morman, the minimum legal drinking age, percent residing in “dry” counties, percent of drivers aged 15-24, average miles per driver, whether the state had a mandatory jail sentence, whether the state had mandatory community service, the population of each state, the population of 15 to 17 year old people in each state, , the population of 18 to 20 year old people in each state, , the population of 21 to 24 year old people in each state, the total vehicle miles (millions), the US employment rate, the US employment/population ratio, and GSP rate of charge. The response variables were number of fatalities, number of nighttime fatalities, number of single fatalities, fatalities among 15 to 17 year old individuals, fatalities among 18 to 20 year old individuals, fatalities among 21 to 24 year old individuals, and alcoholic related fatalities. The  study also examined the nighttime fatalities involving the three different age groups (15-17, 18-20, 21-24). The objective of this project is to build a predictive model from the data of the previous study that predicts the percentage of vehicle fatalities that are alcohol related. The predictor variables that are being considered are alcohol related. They are jail, service, tax on beer (beertax), minimum drinking age (drinkage), percent residing in dry counties (dry), and preliminary breath test law (breath). However after some further research it was found that unemployment is also positively correlated with alcohol misuse so unemployment was added as a variable as well. The response variables will be alcoholic fatality rate (alcoholic fatalities per 10000 people), fatality rate  (vehicle fatalities per 10000 people), and proportion of alcoholic fatalities (alcoholic fatalities over total fatalities). afatal (number of alcohol-involved vehicle fatalities), pop (population), state (factor indicating state), year (factor indicating year), spirits (spirits consumption), beertax (tax on case of beer), drinkage (minimum legal drinking age), dry (percent residing in “dry” counties), unemp (unemployment rate), jail (mandatory jail sentence), service (mandatory community service), and breath (preliminary breath test law). The unit of analysis was people in each state for each year so the variables state and year were included from the data set. According to a 2017 study by WalletHub there were significant difference in strict DUI and DWI laws in the 50 states and the District of Columbia. States with the strictest laws were Arizona, Georgia, Alaska, Kansas, and Oklahoma. States with the most lenient laws were Idaho, North Dakota, Ohio, District of Columbia, and South Dakota. This means that states could be a factor in proportion of alcoholic fatalities. The data was accessed using the AER package in R.

# Descriptive analysis 

## Overview
In response to the goal of this analysis, there are various metrics that one can use to understand the severity of alcohol-related vehicle fatalities throughout the USome of which include the number of alcohol-related fatalities per state, or the rate of alcohol-related fatalities per 10k people, or even the ratio between alcohol-related fatalities with overall fatalities. Each metric will produce different results and different interpretation. 

To get a good sense on how the type of metric can affect the interpretation of the outcome, we observe the map below, which plots each state in the USA with different shades of purple to signify the different mean proportion of alcohol-related fatalities by state. As we hover over the following map, we can see that California (CA) has one of the largest number of alcohol-related fatalities in the country (averaging more than 5000 deaths per year), yet its rate of alcohol-related fatalities per 10k people of 1.9 is almost half of that of Texas (TX) (3.6 alcohol-related fatalities per 10k people). On the other hand, if we were to compare the ratio of alcohol-related fatalities to overall fatalities, both California (0.26) and Texas' (0.41) statistics were far below that of Mississippi's (0.52).

These differences show the importance of choosing the suitable metric for the purpose of this data analysis. The choice of metric will be discussed in Section 4.2.1.2.
```{r}
## Liela's codes
library(AER)
library(ggplot2)
library(plotly)
library(tidyverse)
library(dplyr)
data("Fatalities")

data <- Fatalities  %>%
  mutate(fatal_r=(fatal/pop)*10000,afatal_p=(afatal/fatal)) %>% 
  select(state,year,fatal_r,afatal_p,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,afatal)

# mean (years)
mapping <- data %>%  
  select(state,year,afatal_p,fatal_r,pop,fatal,afatal) %>%
  mutate(state=toupper(state))
map <- mapping %>% 
  group_by(state) %>% 
  summarise(fatal=round(mean(fatal),2),
            fatal_r_mean=round(mean(fatal_r),2), 
            afatal_p_mean = round(mean(afatal_p),2))
map$hover <- with(map, paste(state, "<br>Mean Fatalities/year: ", fatal, "<br>Mean Fatalities per 10k pop./year: ", fatal_r_mean, "<br>Mean % Alc. Related Fatalities: ", afatal_p_mean))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
fig <- plot_geo(map, locationmode = 'USA-states')
fig <- fig %>% 
  add_trace(
    z = ~afatal_p_mean, text=~hover,locations = ~state,
    color = ~afatal_p_mean, colors = 'Purples'
  )
fig <- fig %>% 
  colorbar(title = "Mean % Alc. Related Fatalities")
fig <- fig %>% 
  layout(
    title = 'US Traffic Fatalities',
    geo = g,
  yaxis = list(type = "identity")
  )
fig
rm(list=ls())
```

## Exploratory Data Analysis
As the focus of this data analysis is to find out whether laws that were implemented to tackle drunk driving related fatalities, only a subset of the variables from the `Fatalities` dataset were used. In particular, response variables that were alcohol-related such as the total number of fatalities and alcohol fatalies were examined, while predictor variables that are closely related to alcohol-consumption-driven laws were also analyzed.

### Univariate Analysis
We start off the exploratory data analysis procedure by individually examining the predictor and response variables. The goal here is to understand how the data is distributed, which helps set an expectation on how the variables correlate with each other, or whether certain model assumptions will be met.

#### Predictor Variables
As we look into how alcohol consumption driven laws impact the rate of alcohol-related fatalities, some variables of interest include spirit consumptions, beer tax, proportion of the population living in dry counties, minimum drinking age, and the mandatory punishments implemented by each state throughout the 7 years.

The plot below shows the top 5 states in terms of average spirits consumptions, average beer tax, and average proportion of population living in dry counties between 1982 and 1988. Other than North Carolina (NC) being in the top 5 states for beer tax and containing large proportion of dry residents, it can be seen that there is no other "standout" state below, ie. there's no state present in more than one of the top 5 categories.
```{r}
## Yixing's codes
library(tidyverse)
library(AER)
library(ggplot2)
library(grid)

data('Fatalities')
Fatalities$state = toupper(Fatalities$state)
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

factor1 = names(drunkdrive) %in% c("year","breath","jail","service")
factor2 = names(drunkdrive) %in% c("state","breath","jail","service")
state_mean = aggregate(.~state,data=drunkdrive[,!factor1], FUN = "mean")
year_mean = aggregate(.~year,data=drunkdrive[,!factor2], FUN = "mean")

#state mean spirits consumption ordered bar chart
state_mean_subset = state_mean[order(state_mean$spirits, decreasing = TRUE)[1:5],1:2]
p1 = ggplot(state_mean_subset,aes(x=reorder(state,-spirits),y=spirits)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Spirits Consumption")
#state mean beertax ordered bar chart
state_mean_subset = state_mean[order(state_mean$beertax, decreasing = TRUE)[1:5],c(1,3)]
p2 = ggplot(state_mean_subset,aes(x=reorder(state,-beertax),y=beertax)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Beer Tax")
# state_mean dry ordered bar chart
state_mean_subset = state_mean[order(state_mean$dry, decreasing = TRUE)[1:5],c(1,5)]
p3 = ggplot(state_mean_subset,aes(x=reorder(state,-dry),y=dry)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "% Dry County Residents")

gridExtra::grid.arrange(p1,p2,p3, nrow = 1,
                        top = textGrob("Top 5 States in Spirits Consumption, Beer Tax, and % Dry Residents",gp=gpar(fontsize=15,font=3)))
rm(list=ls())
```

On the other hand, it can be seen that there has been an increasing implementation/tightening of laws throughout the 7 years. The most obvious changes here is the number of states that increased the minimum drinking age. In 1982, almost half the country had set their minimum drinking age to be less than 21, and yet most of the states have opted for 21 to be the minimum drinkage 7 years later.

Additionally, there seem to be a slight increasing trend in the number of states that implement testings (breath test) and punishments (mandatory jail sentence and mandatory community services) between 1982 and 1988. We need to note, however, that the number of states implementing mandatory jail sentences decreased very slightly from 1986 to 1988. This raises the question of whether a mandatory jail sentence is effective in combating the issue of drunk driving. Such questions will be addressed after fitting a suitable model.
```{r}
## Yixing's codes
library(AER)
library(ggplot2)
data("Fatalities")
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

# bar plot
# drinkage: categorized to four levels: [18,19),[19,20),[20,21),[21,22])
drinkagec <- cut(drunkdrive$drinkage,
  breaks = 18:22, include.lowest = TRUE, right = FALSE)
drunkdrive <- drunkdrive %>% mutate(drinkagec = drinkagec)
# stacked barchart of drinkage for each year (many states changed their min. drinking age over yers)
drinkage_year = drunkdrive %>% group_by(year,drinkagec) %>%
  summarise(state_number = n())
p2 = ggplot(drinkage_year,aes(x=year,y=state_number,fill=drinkagec))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Min. drink age") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=8), axis.text.x = element_text(angle=45))

# stacked barchart of breath for each year (many states changed their min. drinking age over yers)
breath_year = drunkdrive %>% group_by(year,breath) %>%summarise(state_number = n())
p3 = ggplot(breath_year,aes(x=year,y=state_number,fill=breath))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Prelim. breath test") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7), axis.text.x = element_text(angle=45))

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
jail_year = drunkdrive %>% group_by(year,jail) %>%summarise(state_number = n())
p4 = ggplot(jail_year,aes(x=year,y=state_number,fill=jail))+
  geom_bar(position="Fill",stat="identity") +
  labs(y="Percent of states", fill = "Mand. Jail") + 
  scale_fill_brewer(palette="Blues") + 
  theme(axis.text.x = element_text(angle=45))

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
service_year = drunkdrive %>% group_by(year,service) %>%summarise(state_number = n())
p5 = ggplot(service_year,aes(x=year,y=state_number,fill=service))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Mand. comm. service") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7), axis.text.x = element_text(angle=45))

# draw all plots
gridExtra::grid.arrange(p2,p3,p4,p5, nrow = 2)

rm(list=ls())
```

#### Response Variables
After observing the trend of the implemented laws, the focus is now switched to analyzing the distribution of fatalities and alcohol fatalities across the country. A quick look at the top two histograms below might suggest that a large portion of states have less than 1000 fatalities per year, and less than 500 alcohol related fatalities per year. However, each state's population need to be taken into account in this case due to the significant variation in population sizes across the country. Our new histograms (bottom two) tell us that the distributions of the data can be approximated as normal. 

Since the goal of this analysis is to discuss the effects of alcohal-related law implementations, the alcohol-related fatalities becomes our main topic of interest. There are a number of approaches in determining the best metric for observing such specific fatalities, among which is the number of alcohol related fatalities per 10k people. However, the issue with such a metric is that it does not tell a good story on whether the implemented traffic policies had success in reducing the number of alcohol-related fatalities. Other factors could have come into play which resulted in a lower overall fatality rate in general, which in turn affects the alcohol-related fatalities rate. 

In this analysis, the metric used for analyzing the effect of traffic laws on alcohol-related fatalities is the proportion of alcohol-related fatalities among the overall fatalities by state and year, ie.
$$
p = \frac{\text{Number of alcohol-related fatalities}}{\text{Number of overall fatalities}}
$$
An advantage of this metric for the purpose of this data analysis is its robustness to the changes in overall fatalities. In other words, $p$ is still able to give us useful and unbiased information on alcohol-related fatalities in response to the changes in overall fatalities in certain states or years.
```{r}
## Zengfung's codes
library(AER)
data("Fatalities")
attach(Fatalities)

par(mfrow=c(2,2))
hist(fatal, main = "Number of Fatalities", xlab = "fatalities")
hist(afatal, main = "Number of Alc. Related Fatalities", xlab = "alcohol fatalities")
hist(fatal/pop*10000, main = "Fatalities/10k pop.", xlab = "fatalities/10k pop.")
hist(afatal/fatal, main="% Alc. Fatalities", xlab = "% fatalities related to alcohol")

rm(list=ls())
```

The plot below shows the proportion of alcohol-related fatalities of each state throughout the years. It can be seen that the proportion of alcohol-related fatalities have been either constant or decreasing in those 7 years. This is more prevalent in states such as Kansas (KS), North Dakota (ND), and Arkansas(AR). 
However, there is one exception to this trend. In the line plot below, we observe that Mississipi had a significant increase in the proportion of alcohol fatalities from 1983 to 1988.
```{r}
## Liela's codes
library(AER)
library(plotly)
library(dplyr)
data("Fatalities")
Fatalities$pafatal = Fatalities$afatal/Fatalities$fatal
Fatalities$state = toupper(Fatalities$state)

Fatalities %>%
  group_by(state) %>%
  plot_ly(x = ~year, y = ~pafatal, color = ~state) %>%
  add_lines(text = ~state) %>%
  layout(title = "% Alc. Fatalities by State",
         xaxis = list(title = "Year"),
         yaxis = list(title = "% Alc. Fatalities"))

rm(list=ls())
```

### Multivariate Analysis
In this section, we will observe the pairwise interaction between the predictor and response variables. The first thing that was done was to examine the correlation between each pair of continuous predictor variables. In the scatterplot matrix below, it is obvious that there were no distinct patterns between the predictor variables throughout all years, which suggest low correlation between all pairs of continuous predictors.
```{r}
## Apurv's codes
library(AER)
library(ggplot2)
library(GGally)
library(plotly)
library(dplyr)
library(panelr)
library(tidyverse)

# load data
data("Fatalities")
attach(Fatalities)
pafatal = afatal/fatal
Fatalities$pafatal = pafatal
state = toupper(state)
dataset<- data.frame(year,state,unemp,beertax,drinkage,jail,service,breath,dry,pop,pafatal,spirits)
dataset<-na.omit(dataset)

# pairs plot
p = ggpairs(data = dataset, 
            columns = c("unemp", "beertax", "dry", "spirits"), 
            mapping = aes(frame = as.character(year), label = state, alpha = 0.5),
            upper = list(continuous = "points"),
            lower = list(continuous = "cor")) +
  ggtitle("Pairs plot between predictor variables") 
ggplotly(p)

rm(list=ls())
```

Another thing we want to ensure prior to fitting any models in this analysis is the non-presence of the variance inflation factor (VIF). The VIF of the $k$th predictor, denoted as $VIF_k$, is defined as 
$$
VIF_k = \frac{1}{1-R_k^2}
$$
where $R_k^2$ is the coefficient of multiple determination when the predictor variable $X_k$ is regressed onto the rest of the $X$ variables. Intuitively, a large $VIF_k$ value means that the predictor $X_k$ can be well explained by the other $X$ variables, which would ultimately lead to the multicollinearity phenomenon. Notice that $R_k^2 \geq 0$, and therefore $VIF_k \geq 1$. This means that we want to obtain $VIF$ values that are as small as possible and as close to 1 as possible to prevent multicollinearity.

In the table below, we see that all the $VIF_k$ values are close to 1, signifying that multicollinearity is not an issue in this data set.

```{r}
library(AER)
data("Fatalities")
Fatalities$drinkage = as.factor(floor(Fatalities$drinkage))
Fatalities$pafatal = Fatalities$afatal/Fatalities$fatal

lm.model = lm(pafatal ~ unemp + beertax + dry + spirits + drinkage + jail + service + breath,
              data = Fatalities)
VIF = car::vif(lm.model)[,1]
data.frame(VIF)
rm(list=ls())
```

With the predictor variables analyzed, we now proceed to the pairwise interactions between those predictor variables and the proportion of alcohol-related fatalities. In the series of boxplots below, we gain some insights that one would generally expect: 

* The proportion of alcohol-related fatalities show a decreasing trend troughout the years. <br>
* The proportion of alcohol-related fatalities is slightly lower when a mandatory community service is being implemented. <br>
* The proportion of alcohol-related fatalities is slightly lower when a preliminary breath test is being implemented. <br>
* The proportion of alcohol-related fatalities decreases as the minimum drinking age increases. However, note that the boxplot of alcohol-related fatalities when the minimum drinking age is 21 has a significantly larger variance.

On the other hand, an interesting finding from these boxplots that mandatory jail sentences somehow correlate with a larger proportion of alcohol-related fatalities. This unexpected finding could also be the reason that the number of states implementing such policy decreased between 1986 and 1988, as shown in the previous section.

```{r}
## Apurv's codes
library(AER)
library(ggplot2)
library(GGally)
library(plotly)
library(dplyr)
library(panelr)
library(tidyverse)

# load data
data("Fatalities")
attach(Fatalities)
pafatal = afatal/fatal
Fatalities$pafatal = pafatal
state = toupper(state)
dataset<- data.frame(year,state,unemp,beertax,drinkage,jail,service,breath,dry,pop,pafatal,spirits)
dataset<-na.omit(dataset)

par(mfrow = c(2,3))
boxplot(pafatal~year, main = 'Alc.Fatality % vs Year',
        xlab = 'Year', ylab = 'Alc. Fatality Rate', col=rainbow(7),
        cex.main=1)

boxplot(pafatal~jail, main ='Alc.Fatality % vs Jail',
xlab='Jail',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=1)

boxplot(pafatal~service, main ='Alc.Fatality % vs Service',
xlab='Service',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=1)

boxplot(pafatal~breath, main ='Alc.Fatality % vs Breath Test',
xlab='Breath',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=1)

drinkage = as.factor(floor(drinkage))
Fatalities$drinkage = drinkage
boxplot(pafatal~drinkage, main = 'Alc.Fatality % vs Drinkage',
        xlab = "Drink Age", ylab = "Alc. Fatality Rate", col=rainbow(4),
        cex.main=1)
rm(list=ls())
```

After observing the change in proportion of alcohol-related fatalities in response to categorical variables and time, we then aim to do the same with the continuous predictor variables. In the interactive scatter plots below, each data point is colored by its implementation of the madatory jail sentence due to the unexpected findings from previous sections. While no concrete conclusions can be made in that regard, it can be seen that the data points in all four plots converge to the bottom left corner as the years go by. This tells us that:

* The proportion of alcohol-related fatalities have decreased over the years, except for Mississippi. After the year 1985, the proportion of alcohol-related fatalities kept on increasing, while the proportion for other states have continuously decreased. By 1987 and 1988, Mississippi was the outlier in this data. <br>
* With the exception of the proportion of dry residents, the beer tax, unemployment rate, and spirits consumption generally observed a decreasing trend for all states throughout the 7 years.

Based on what we have seen so far, it does seem as if these policies did gain a positive effect in the long run. Even if the decreasing amount of beer tax resulting in a decreased proportion of alcohol-related fatalities seemed non-intuitive, it could be due to the fact that there is a time-lag/latency element to consider where people take time to adjust to high beer taxes before tending to lower alcohol purchase and intake, which ultimately results in lower alcohol-related fatalities.

```{r}
## Zengfung's codes
library(ggplot2)
library(plotly)
library(AER)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$state = toupper(Fatalities$state)
Fatalities$afatal_prop = Fatalities$afatal/Fatalities$fatal
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

p1 = ggplot(data = Fatalities, 
            aes(x = dry, y = afatal_prop, label = state, color = jail, frame = year)) + 
  geom_point(alpha = 0.7) + 
  ylab("% alcohol fatalities") +
  ggtitle("Dry, Beer Tax, Unemployment %, and Spirits Consumption") +
  theme(legend.title = element_blank(), legend.position = "none")
p2 = ggplot(data = Fatalities, 
            aes(x = unemp, y = afatal_prop, label = state, color = jail, frame = year)) + 
    ylab("% alcohol fatalities") +
    geom_point(alpha = 0.7) + 
    theme(legend.title = element_blank(), legend.position = "none")
p3 = ggplot(data = Fatalities, 
            aes(x = beertax, y = afatal_prop, label = state, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  labs(color = "Jail")
p4 = ggplot(data = Fatalities, 
            aes(x = spirits, y = afatal_prop, label = state, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  theme(legend.title = element_blank(), legend.position = "bottom")

fig = subplot(ggplotly(p1), ggplotly(p3), ggplotly(p2), ggplotly(p4), nrows = 2, shareY = TRUE)
fig 

rm(list=ls())
```

Lastly, we turn to analyzing the distribution of young drivers (aged between 15-24) throughout the years. While this may not be directly correlated with the current data analysis, it would be interesting to see if the change in the minimum drinking age has any effect on the distribution of young drivers. As expected, with the increase in the minimum drinking age, the proportion of young drivers decreased. This could be due to the decrease in proportion of legal young drivers, which in turn correlates with the decreasing proportion of alcohol related fatalities (shown in scatterplots on the right).

```{r}
## Zengfung's codes
library(AER)
library(ggplot2)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))
Fatalities$pafatal = Fatalities$afatal/Fatalities$fatal

p1 = ggplot(data = Fatalities, aes(x = youngdrivers, fill = drinkage_cat)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  facet_grid(rows = vars(year)) +
  labs(x = "% Young Drivers", fill = "Min. Drink Age") +
  ggtitle("Dist. of Young Drivers Proportions") +
  theme(legend.position = "none",
        plot.title = element_text(size=10))

p2 = ggplot(data = Fatalities, aes(x = youngdrivers, y = pafatal, color = drinkage_cat)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(year)) +
  labs(x = "% Young Drivers", y = "% Alc. Fatality", color = "Min. Drink Age") +
  ggtitle("% Young Drivers vs Alc. Related Fatalities") +
  theme(legend.position = "none",
        plot.title = element_text(size=10))

# hacky fix to get legend
p3 = ggplot(data = Fatalities, aes(x = youngdrivers, y = pafatal, color = drinkage_cat)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(year)) +
  labs(x = "% Young Drivers", y = "% Alc. Fatality", color = "Min. Drink Age") +
  ggtitle("% Young Drivers vs Alc. Related Fatalities") +
  theme(legend.position = "bottom")
my_legend = cowplot::get_legend(p3)

lay = rbind(c(1,2),
            c(1,2),
            c(1,2),
            c(1,2),
            c(1,2),
            c(3,3))
gridExtra::grid.arrange(p1,p2, ggpubr::as_ggplot(my_legend),layout_matrix = lay,
                        top = "Effects of Min. Drinking Age and Proportion of Young Drivers on Alcohol-related Fatalities")

rm(list=ls())
```

With all of those in mind, we can then move on to fitting an appropriate model and produce some causal inference for this data.

# Inferential analysis 

```{r set up, include=FALSE}
library(AER)
library(gplots)
library(plotly)
library(tidyverse)
library(dplyr)
library(plm)
library(MASS)
data("Fatalities")
Fatalities$drinkage <-as.factor(floor(Fatalities$drinkage))
# apply(is.na(Fatalities), 2, which) 
data <- Fatalities  %>%mutate(fatal_r=(fatal/pop)*10000,afatal_r=(afatal/pop)*10000,afatal_prop=afatal_r/fatal_r) %>% dplyr::select(state,year,fatal_r,afatal_r,afatal_prop,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,nfatal) %>% drop_na()
#########  model fitting ############
plm_ap <- plm(afatal_prop~spirits+unemp+beertax+drinkage+dry+breath+jail+service,data=data,index=c("state", "year"),model="within")
summary(plm_ap)
```

As we noticed, this data set is panel data, having several repeated measures (6 for CA and 7 for else) for each state. Thus, we want to use fixed effects representing the state-specific means, and a fixed-effect model was fitted. Since it is a question-driven analysis based on p-values and variables of interest, eventually, we included five predictors in our final model: spirits consumption, minimum legal drinking age, preliminary breath test law, mandatory jail sentence, and mandatory community service.

## One-way individual fixed effect model
$$
Y_{it}=\alpha_i+\beta_1 X_{it,1}+\beta_2 X_{it,2}+\beta_3 X_{it,3}+\beta_4 X_{it,4}+\beta_5 X_{it,5}++\beta_6 X_{it,6}+\beta_7 X_{it,7}+\epsilon_{it}
$$


### Parameter notation:

$i=1,2\dots,48$: state index; $t=1,2,\dots,6,7.$: time index.

$Y_{it}$: ratio of number of alcohol-involved vehicle fatalities to overall vehicle fatalities for state $i$ and year $t$. $Y_{it}=\frac{Number of alcohol involved vehicle fatalities_{it}}{Number of vehicle fatalities_{it}}$.

$\alpha_i$: State-specific parameter (unobserved time-invariant individual effect) for state $i$.

$\beta_1,\beta_2,\beta_3,\beta_4,\beta_5,\beta_6,\beta_7$: represents for coefficients of spirits, drink-age 19, drink-age 20, drink-age 21, jail, service, breath, respectively.

$X_{it,1}$: is a continuous variable; $X_{it,2},X_{it,3},X_{it,4},X_{it,5},X_{it,6},X_{it,7}$ are dummy variables.

Notice: since we dropped one observation with missing values (CA 1988), we have unbalanced panel.

### Assumptions:

(1) Conditional relationship of $Y_{it}$ given {$X_{it,1},\dots, X_{it,7}$} is linear in the explanatory variables.

(2) $\epsilon_{it}$ are independent random variables with zero mean and constant variance: $$E(\epsilon_{it})=0,\  Var(\epsilon_{it})=\sigma^2$$

### Model justifing
```{r final model, include=FALSE}
# - beertax; drinkage; dry; ------? breath;unemp
plm_final <- plm(afatal_prop~spirits+drinkage+jail+service+breath,data=data,index=c("state", "year"),model="within")
coeftest(plm_final)
summary(plm_final)
```
```{r  model justifing, include=FALSE}
##########  Display the fixed effects (constants for each country)
fixef(plm_final)
##########  Testing for fixed effects, null: OLS better than fixed
ols <- lm(afatal_prop~spirits+unemp+beertax+drinkage+dry+breath+jail+service,data=data)
pFtest(plm_final, ols)                          # ------- fixed effect model better 
######### # Hausman test: fixed vs random model
random <- plm(afatal_prop~spirits+drinkage+jail+service+breath,data=data,index=c("state", "year"),model="random")
phtest(plm_final, random)                       # ------ choose fixed model 
######### # Testing for time-fixed effects
time <- plm(afatal_prop~spirits+drinkage+jail+service+breath+year,data=data,index=c("state", "year"),model="within")
pFtest(time,plm_final)
plmtest(plm_final, c("time"), type=("bp"))      # ----no need to use time-fixed effects
```

- Test for heterogeneity: To know whether the intercepts for each state are equal or not, an F test for individual effects was conducted. $H_0:\alpha_1=\dots=\alpha_{48}$ vs. $H_0:$ not all $\alpha_i$ are equal. P-value $< 2.2e-16$ indicates rejecting the null hypothesis, which corresponds to our intuition of using fixed effects rather than ordinary least squares.

- Test for fixed effect over random effect model: To decide between fixed and random effects, we used the Hausman test: $H_0:$ Random effects vs. $H_a$: Fixed effects. P-value $< 2.2e-16$ means fixed effects model is more appropriate.

- Test for time-fixed effects: $H_0:$ need time-fixed effects vs. $H_a:$ no need for time-fixed effects. Both F-test for individuals effects (p-value=0.015) and Largrange Multiplier test (p-value=0.001) show no need to use time-fixed effects.


# Sensitivity analysis 

```{r model justify,include=FALSE}
##########  Testing for cross-sectional dependence
pcdtest(plm_final, test = c("lm"))              # ------ Cross-sectional dependence
pcdtest(plm_final, test = c("cd"))              # ------ cross-sectional dependence
######### # Testing for serial correlation      # ------ not necessary for micro panel
pbgtest(plm_final)                              # ------ serial correlation 
######### # Testing for unit roots/stationarity
Panel.set <- plm.data(data, index = c("state", "year"))
library(tseries)
adf.test(Panel.set$afatal_prop, k=2)              # ------- no unit roots present
```
```{r multicollinearity, include=FALSE}
#########  multicollinearity ############
design_matrix <- as.data.frame(model.matrix(plm_final))
design_matrix$afatal_prop <-plm::Within(plm::pdata.frame(data,index = "state")$afatal_prop)
# c <- c("drinkage19","drinkage20","drinkage21","breathyes","jailyes","serviceyes")
# library(magrittr)
# design_matrix %<>% mutate_at(c,funs(factor(.)))
design_matrix <- design_matrix %>% mutate()
lm_fit1 <- lm(afatal_prop~spirits+drinkage19+drinkage20+drinkage21+breathyes+jailyes+serviceyes, data=design_matrix)                         #------ no multicollinearity
# VIF score
car::vif(lm_fit1)                                  #-------- small VIF scores
```

- Testing for cross-sectional dependence: Though, in our case, we have micro panels with few years and a large number of subject/states, whether residuals across entities are correlated or not was tested cautiously. Unfortunately, both Breusch-Pagan LM test and Pesaran CD test show cross-sectional dependence. Hence, the assumption regarding independent subjects is violated. Potential reasons and consequences of this dependence will be discussed in the discussion section.

- Testing for unit roots: Since the Augmented Dickey-Fuller test (p-value <0.01) indicates no unit roots present, no further transformation of variables is needed.

- Test for multicollinearity: Since VIF scores are relatively small (the biggest one is 6 - drinking age 21), we concluded there is no multicollinearity issue. 

- Test for homoscedasticity: Based on the below residuals plots, the smooth curve for residual is relatively identical to the x-axis; thus, we conclude that the homoscedasticity assumption holds.

```{r residuals,include=FALSE}
#########  Homoscedasticity ############
fitted.values<-as.numeric(data$afatal_prop - residuals(plm_final))
# studentized residuals
X <- model.matrix(plm_final)
P <- X %*% solve(t(X) %*% X) %*% t(X)
sigma.sq <- (1 /plm_final$df.residual)*sum(residuals(plm_final)^2)
student.res <- residuals(plm_final)/(sigma.sq * (1-diag(P)))
```
```{r residuals plots,echo=FALSE,fig.height=4, fig.width=8}
par(mfrow=c(1,2))
plot(fitted.values,residuals(plm_final),bty='n',xlab='Fitted values', ylab='Residuals',main='Residuals vs. Fitted values')
lines(smooth.spline(fitted.values,residuals(plm_final), spar=1.2), col=2)
abline(h=0,col='red',lty='dashed')
# studentized residuals
plot(fitted.values,student.res,bty='n',xlab='Fitted values', ylab='Residuals',main='Studentized residuals vs. Fitted values')
lines(smooth.spline(fitted.values,student.res, spar=1.2), col=2)
abline(h=0,col='red',lty='dashed')              # -------- suspect heteroscedasticity?
```

- Test for normality: From the QQ plots of two residuals, we can see slight heavy tails at left and right tails. But, we think it only shows a slight deviance from normality and concluded the residuals are normal distributed. 

```{r normality, echo=FALSE,fig.height=4, fig.width=8}
par(mfrow=c(1,2))
qqnorm(residuals(plm_final),main= "QQ plot of residuals")
qqline(residuals(plm_final),col='red')
qqnorm(student.res,main= "QQ plot of studentized residuals")
qqline(student.res,col='red') # ----- normal
```

- Test for outliers: From the leverage plot, we can see no there are no specious leverage values. Hence, we concluded no large outliers.

```{r Influential Observations,include=FALSE}
require(faraway)
halfnorm(diag(P),labs=1:335, ylab='Leverages',nlab=1) # 2p/n=0.06
# data[175,] # --- nv 1982
# data %>% filter(state=="nv") # nv 1982 no -> yes; unemp
```
```{r leverage plot,echo=FALSE,fig.height=4, fig.width=6}
halfnorm(diag(P),labs=1:335, ylab='Leverages',nlab=1) 
```


# Causal interpretation 
Based on the final model, three factors were significant in explaining the change in alcohol-related fatalities ration: spirits consumption, mandatory jail sentence, and mandatory community service for driving-under-influence, after controlling for preliminary breath test law, and minimum drinking age. The assumptions needed for causal inference, problems with current model, and possible solutions were discussed here.

In panel data, measures were conducted on the same entity (state) repeatedly at different time points (years). The fixed effect model adopted in the current project accounted for unobserved, entity-specific, time-invariant confounders. Given these features, this model controlled for the effect of some unmeasured or un-measurable factors that differed across states on alcohol fatalities ratio. Therefore, if no model assumptions were violated, then we should be able to make causal inference on the significant factors within each state. Our model essentially explained how the change in the response variable overtime specific to a state ($Y_{it}-\bar{Y}_i$), could be explained by the change in predictors of that state ($X_{it}-\bar{X}_i$).

However, the model diagnosis result showed that our model had cross-sectional dependence, which is a violation of the model assumption that states should be independent of each other. Although each state had their own legislative system, the federal law can still largely affect state laws by witholding or providing funding to encurage the passage of a law. For example, in 1984, federal legislation prompted all 50 states to adopt the 21 minimum legal drinking age law by 1988 [9]. Thus under the same big policy environment, it is unlikely that each state's legislation were uncorrelated. Because the model adopted in the current project assumed independent entities, violation of such assumption might lead to bias in our results that invalidate causal inference.

Besides the original model assumptions, the fixed effect model also requires strong exogeneity in order to make causal inference, including: (a) no unobserved time-varying confounders; (b) past outcomes do not directly affect current outcome; (c) past treatments do not directly affet current outcome; (d) past outcome do not directly affect current treatment (reverse causation) [10]. Assumption (a) is hard to verify and also difficult to relax under the fixed effect model. Thus we assumed no time-varying covariates were omitted from the current model and see whether the other assumptions were violated in the current model and how they can be relaxed. 

Assumption (b) can be relaxed without interfering with the causal inference between current treatment and current outcome so long as we condition on past treatment, and assuming past outcome does no directly affect current treatment. For assumption (c), it is highly likely that our model did not conform to this assumption. It is natural for laws and regulations to have a lagged effect: the laws passed this year might not have an effect until the next. To relax assumption (c), we could add a small number of lagged treatment effect into the model (e.g. treatment from the year before) for the "breath","jail", and "service" predictors. Last, for assumption (d): no reverse causation, a popular approach to relax it is to include instrumental variables for endogenous predictors. Endogenous predictors are those included in the model but are correlated with the error term. This could happen when the response variable can reversely cause the predictor, or some omitted confounders can affect both dependent and independent variables. Instrumental variables were those not included in the model, associated with the endogenous predictor, but not associated with the unobserved confounders. 

The factor of concern for violation of assumption (d) is spirits consumption. Some previous studies on the traffic policy environment and fatality rate suggested using alcohol regulations as instrumental variables for alcohol consumption when investigating the effect of alcohol consumption on traffic accidents fatality. Such alcohol regulations can only affect traffic accident fatality through alcohol consumption, and there were previous studies showing significant effect of such regulations on alcohol consumption. In the current dataset, the covariate related to alcohol consumption is "spirits", and alcohol regulations include "drinkage" (minimum drinking age), and "beertax". To verify the approporiateness of drinkage and beertax as instrumental variables for spirits consumption, under-identification, weak instrument, and over-identification need to be tested. To test for under-identification is to test the null hypothesis that spirits and beertax or drink age are irrelevant. This could be done through simple t-test and likelihood ratio test. The result showed that beertax was not associated with spirits consumption (Pr(>F) = 0.1012), but drinkage had significant effect (Pr(>F) <0.0001). Thus, beertax failed the under-idetification test. Weak instrument was tested by calculating Cragg-Donald F statistic and comparing it against Stock and Yogo critical values. The null hypothesis (the instrumental variables are weak) can be rejected if the Crgg-Donald F statistic is greater than the criticla value. The Cragg-Donald F statistic calculated for drinkage was 10.59, and the critical value was 22.3, thus we failed to reject the null at significance level 0.05. As a result, we could not find appropriate instrumental variables for spirits in the current dataset. If more measures are availble, such as other alcohol regulations and other alcohol consumption information, we might be able to find more suitable instrument variables.


# Discussion 


# Acknowledgement {-}
Working codes can be found at: https://github.com/zengfung/TrafficFatalityAnalysis.git. 

# Reference {-}
[1] National Center for Health Statistics (US. (2011). Health, United States, 2010: With special feature on death and dying.
[2] Facts, T. S. (2012). Alcohol-Impaired Driving. DOT HS, 811, 630.
[3] Desapriya, E. B., Iwase, N., & TAYE, B. N. (2002). Alcohol related traffic safety legislation: Where do we stand today?. IATSS research, 26(2), 76-84.
[4] National Highway Traffic Safety Administration. Fatality Analysis Reporting System (FARS). Washington, DC: cited 2013 March; Available from: http://www.nhtsa.gov/FARS
[5] Hingson, R. W., Howland, J., & Levenson, S. (1988). Effects of legislative reform to reduce drunken driving and alcohol-related traffic fatalities. Public Health Reports, 103(6), 659.
[6] Wagenaar, A. C., Maldonado-Molina, M. M., Ma, L., Tobler, A. L., & Komro, K. A. (2007). Effects of legal BAC limits on fatal crash involvement: analyses of 28 states from 1976 through 2002. Journal of safety research, 38(5), 493-499.
[7] Voas, R. B., Tippetts, A. S., & Fell, J. C. (2003). Assessing the effectiveness of minimum legal drinking age and zero tolerance laws in the United States. Accident Analysis & Prevention, 35(4), 579-587.
[8] Wagenaar, A. C., Maldonado-Molina, M. M., Erickson, D. J., Ma, L., Tobler, A. L., & Komro, K. A. (2007). General deterrence effects of US statutory DUI fine and jail penalties: long-term follow-up in 32 states. Accident Analysis & Prevention, 39(5), 982-994.
[9] Silver, D., Macinko, J., Bae, J. Y., Jimenez, G., & Paul, M. (2013). Variation in US traffic safety policy environments and motor vehicle fatalities 1980–2010. Public health, 127(12), 1117-1125.
[10] Imai, K., & Kim, I. S. (2019). When should we use unit fixed effects regression models for causal inference with longitudinal data?. American Journal of Political Science, 63(2), 467-490.
[11] Edward W. Frees. (2004). Longitudinal and Panel Data: Analysis and Applications for the Social Sciences.
[12] Oscar Torres-Reyna. (2010). Getting started in Fixed/Random Effects Models using R.
[13] K. Arthur Endsley. (2019). Implementing fixed effects panel models in R.
# Session info {-}
```{r}
sessionInfo()
```
